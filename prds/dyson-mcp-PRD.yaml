# ============================================================================
# DYSON-MCP - MCP Server PRD
# ============================================================================
# Generated by GRIMLOCK Design Wizard - 2025-12-31
# Updated with complete tool definitions
# ============================================================================

version: "1.0"

# ----------------------------------------------------------------------------
# PROJECT METADATA
# ----------------------------------------------------------------------------
project:
  name: "dyson-mcp"
  version: "0.1.0"
  description: |
    MCP server for controlling Dyson air purifiers, fans, and heaters via local MQTT.
    Enables Claude to monitor air quality, control fan settings, and manage device state.
    Uses local MQTT communication after initial cloud authentication for device discovery.

  sdk: "typescript"
  node_version: "18+"

  deployment:
    type: "local"
    transport: "stdio"
    containerized: false

# ----------------------------------------------------------------------------
# TARGET INTEGRATION
# ----------------------------------------------------------------------------
integration:
  service_name: "Dyson Cloud API + Local MQTT"
  service_type: "hybrid"
  auth_type: "oauth2"

  # Dyson uses cloud API for device discovery, then local MQTT for control
  api:
    cloud_base_url: "https://appapi.cp.dyson.com"
    local_mqtt_port: 1883
    documentation_url: "https://github.com/CharlesBlonde/libpurecoollink"
    rate_limits:
      requests_per_minute: 30
      requests_per_day: 5000

  auth:
    type: "email_password"
    description: |
      Dyson uses email/password authentication to the cloud API.
      Cloud API returns device credentials (serial, MQTT password) for local control.
      Two-factor authentication may be required on first login.
    env_variables:
      - name: "DYSON_EMAIL"
        description: "Dyson account email address"
      - name: "DYSON_PASSWORD"
        description: "Dyson account password"
      - name: "DYSON_COUNTRY"
        description: "Country code (e.g., US, GB)"

# ----------------------------------------------------------------------------
# MCP TOOLS SPECIFICATION
# ----------------------------------------------------------------------------
tools:
  - name: "list_devices"
    description: |
      List all Dyson devices registered to your account.
      Returns device name, serial number, type, and connection status.
      Use this first to discover available devices.

    parameters: []

    behavior:
      api_endpoint: "Dyson Cloud + Local MQTT Discovery"
      returns: "array"
      error_handling:
        - condition: "auth_failed"
          response: "Return error about invalid credentials"
        - condition: "no_devices"
          response: "Return empty array with helpful message"

    examples:
      - input: {}
        expected_output: |
          Array of devices with serial, name, type, connected status

  - name: "get_device_status"
    description: |
      Get current status of a specific Dyson device.
      Returns power state, fan speed, oscillation, air quality readings,
      filter life, and environmental data (temperature, humidity).

    parameters:
      - name: "device_id"
        type: "string"
        required: true
        description: "Device serial number or name"

    behavior:
      api_endpoint: "Local MQTT STATUS request"
      returns: "object"
      error_handling:
        - condition: "device_not_found"
          response: "Return error with list of available devices"
        - condition: "device_offline"
          response: "Return error that device is not reachable"

    examples:
      - input:
          device_id: "NK6-US-KFA1234A"
        expected_output: |
          {
            power: "ON",
            fan_speed: 5,
            oscillation: true,
            auto_mode: false,
            night_mode: false,
            air_quality: { pm25: 12, pm10: 8, voc: 3, no2: 2 },
            temperature: 22.5,
            humidity: 45,
            filter_life: 85
          }

  - name: "set_power"
    description: |
      Turn a Dyson device on or off.

    parameters:
      - name: "device_id"
        type: "string"
        required: true
        description: "Device serial number or name"
      - name: "power"
        type: "boolean"
        required: true
        description: "true to turn on, false to turn off"

    behavior:
      api_endpoint: "Local MQTT SET-STATE"
      returns: "object"
      error_handling:
        - condition: "device_not_found"
          response: "Return error with list of available devices"
        - condition: "command_failed"
          response: "Return error with details"

    examples:
      - input:
          device_id: "Living Room"
          power: true
        expected_output: |
          { success: true, message: "Device turned on" }

  - name: "set_fan_speed"
    description: |
      Set the fan speed of a Dyson device.
      Speed range is 1-10, or 'auto' for automatic mode.

    parameters:
      - name: "device_id"
        type: "string"
        required: true
        description: "Device serial number or name"
      - name: "speed"
        type: "string"
        required: true
        description: "Fan speed 1-10 or 'auto'"
        validation:
          pattern: "^(auto|[1-9]|10)$"

    behavior:
      api_endpoint: "Local MQTT SET-STATE"
      returns: "object"
      error_handling:
        - condition: "invalid_speed"
          response: "Return error with valid speed range"
        - condition: "device_off"
          response: "Turn on device first, then set speed"

    examples:
      - input:
          device_id: "Bedroom"
          speed: "auto"
        expected_output: |
          { success: true, fan_speed: "auto" }
      - input:
          device_id: "Bedroom"
          speed: "5"
        expected_output: |
          { success: true, fan_speed: 5 }

  - name: "set_oscillation"
    description: |
      Enable or disable oscillation on a Dyson device.

    parameters:
      - name: "device_id"
        type: "string"
        required: true
        description: "Device serial number or name"
      - name: "oscillate"
        type: "boolean"
        required: true
        description: "true to enable oscillation, false to disable"

    behavior:
      api_endpoint: "Local MQTT SET-STATE"
      returns: "object"

    examples:
      - input:
          device_id: "Office"
          oscillate: true
        expected_output: |
          { success: true, oscillation: true }

  - name: "get_air_quality"
    description: |
      Get detailed air quality readings from a Dyson purifier.
      Returns PM2.5, PM10, VOC, NO2 levels and air quality index.

    parameters:
      - name: "device_id"
        type: "string"
        required: true
        description: "Device serial number or name"

    behavior:
      api_endpoint: "Local MQTT ENVIRONMENTAL-CURRENT-SENSOR-DATA"
      returns: "object"
      error_handling:
        - condition: "not_purifier"
          response: "Return error that device does not have air quality sensors"

    examples:
      - input:
          device_id: "Living Room"
        expected_output: |
          {
            pm25: 12,
            pm10: 8,
            voc: 3,
            no2: 2,
            aqi: "Good",
            temperature: 22.5,
            humidity: 45
          }

  - name: "set_night_mode"
    description: |
      Enable or disable night mode on a Dyson device.
      Night mode reduces fan noise and dims the display.

    parameters:
      - name: "device_id"
        type: "string"
        required: true
        description: "Device serial number or name"
      - name: "enabled"
        type: "boolean"
        required: true
        description: "true to enable night mode, false to disable"

    behavior:
      api_endpoint: "Local MQTT SET-STATE"
      returns: "object"

    examples:
      - input:
          device_id: "Bedroom"
          enabled: true
        expected_output: |
          { success: true, night_mode: true }

# ----------------------------------------------------------------------------
# CONTEXT EFFICIENCY
# ----------------------------------------------------------------------------
context_efficiency:
  tool_count: 7
  estimated_tokens: 3150  # ~450 per tool + params
  level: "optimal"
  scope_recommendation: "project"
  rationale: |
    7 tools is within optimal range (5-10).
    Project-level installation recommended for smart home setups.

# ----------------------------------------------------------------------------
# ACCEPTANCE CRITERIA
# ----------------------------------------------------------------------------
acceptance_criteria:
  functional:
    - id: "AC-001"
      description: "list_devices returns all registered Dyson devices"
      test_method: "automated"
      priority: "must-have"

    - id: "AC-002"
      description: "get_device_status returns current state for a device"
      test_method: "automated"
      priority: "must-have"

    - id: "AC-003"
      description: "set_power can turn device on and off"
      test_method: "automated"
      priority: "must-have"

    - id: "AC-004"
      description: "set_fan_speed accepts 1-10 and 'auto'"
      test_method: "automated"
      priority: "must-have"

    - id: "AC-005"
      description: "get_air_quality returns sensor data"
      test_method: "automated"
      priority: "must-have"

  non_functional:
    - id: "NFR-001"
      category: "security"
      description: "Credentials never logged or exposed"

    - id: "NFR-002"
      category: "performance"
      description: "Local MQTT commands respond within 2 seconds"

    - id: "NFR-003"
      category: "reliability"
      description: "Graceful error handling when device is offline"

# ----------------------------------------------------------------------------
# SECURITY REQUIREMENTS
# ----------------------------------------------------------------------------
security:
  credentials:
    storage: "environment_variables"
    required_env_vars:
      - name: "DYSON_EMAIL"
        description: "Dyson account email"
      - name: "DYSON_PASSWORD"
        description: "Dyson account password"
      - name: "DYSON_COUNTRY"
        description: "Country code (US, GB, etc.)"

  data_sensitivity:
    pii_handling: false
    data_encryption: false
    audit_logging: true

# ----------------------------------------------------------------------------
# TESTING REQUIREMENTS
# ----------------------------------------------------------------------------
testing:
  unit_tests:
    coverage_target: 80
    frameworks: ["jest"]
    key_areas:
      - "MQTT message parsing"
      - "Device state management"
      - "Error handling"

  integration_tests:
    - name: "Mock MQTT broker tests"
      description: "Test device communication with mocked MQTT"
      mock_external: true

  manual_tests:
    - "Test with Claude Desktop"
    - "Test with actual Dyson device"
    - "Verify night mode behavior"

# ----------------------------------------------------------------------------
# DOCUMENTATION REQUIREMENTS
# ----------------------------------------------------------------------------
documentation:
  required:
    - type: "README.md"
      contents:
        - "Installation instructions"
        - "Dyson account configuration"
        - "Available tools with examples"
        - "Troubleshooting (2FA, device discovery)"

    - type: ".env.example"
      contents:
        - "Required environment variables"

# ----------------------------------------------------------------------------
# DESIGN ORIGIN
# ----------------------------------------------------------------------------
design_origin:
  source: "form_wizard"
  interface: "n8n_form"
  design_date: "2025-12-31"
  conversation_summary: |
    Created via GRIMLOCK form wizard.
    Updated with complete tool definitions based on:
    - libpurecoollink Python library
    - homebridge-dyson-pure-cool plugin
    - Home Assistant Dyson integration
    Tools cover device discovery, status monitoring, and control.

# ----------------------------------------------------------------------------
# NOTES
# ----------------------------------------------------------------------------
notes: |
  Dyson API Notes:
  - No official public API - all implementations are reverse-engineered
  - Cloud API is only used for initial device discovery
  - All control commands use local MQTT (port 1883)
  - Two-factor authentication may be required on first login
  - Device credentials (MQTT password) are obtained from cloud API
  - Supported devices: Pure Cool, Pure Hot+Cool, Purifier Humidify

  References:
  - https://github.com/CharlesBlonde/libpurecoollink
  - https://github.com/lukasroegner/homebridge-dyson-pure-cool
  - https://github.com/Grizzelbee/ioBroker.dysonairpurifier
