# GRIMLOCK Development Rules

This file accumulates learned patterns from GRIMLOCK workflow development failures.

## File Structure
- Base path: `/home/ubuntu/projects/grimlock/`
- State file: `GRIMLOCK_STATE.md` (YAML frontmatter)
- Circuit breaker: `CIRCUIT_BREAKER.md`

## N8N Cloud Restrictions
- No js-yaml module
- No external npm packages without verification
- Use built-in JavaScript features only

## Initial Rules (Seed Knowledge)

### [PATH] Always Use Full Paths
When accessing GRIMLOCK files in n8n workflows, use absolute paths:
- ✅ `/home/ubuntu/projects/grimlock/GRIMLOCK_STATE.md`
- ❌ `/projects/GRIMLOCK_STATE.md` (missing subdirectory)

### [FORMAT] YAML Frontmatter Parsing
GRIMLOCK_STATE.md uses YAML frontmatter. Parse with regex:
```javascript
const yamlMatch = content.match(/^---\n([\s\S]*?)\n---/);
```

### [MODULE] No js-yaml in N8N Cloud
Use regex-based parsing instead of js-yaml library.

### [CIRCUIT_BREAKER] Three Severity Levels Required
All circuit breakers must define: WARNING, PAUSE, EMERGENCY

---
*Rules below this line are automatically generated by the Teacher LLM*

### [FORMAT] Never JSON.parse YAML Frontmatter Files

**Rule**: GRIMLOCK state files use YAML frontmatter. Always use regex extraction, not JSON.parse().

**Pattern to avoid**:
```javascript
// ❌ WRONG
const state = JSON.parse(fileContent);
```

**Correct pattern**:
```javascript
// ✅ CORRECT
const yamlMatch = fileContent.match(/^---\n([\s\S]*?)\n---/);
```

**Validation**: Check for JSON.parse() calls on .md files

### [INTEGRATION] SSH Nodes Need Timeout Handling

**Rule**: SSH nodes can timeout on handshake failures. Always configure timeout and add error handling for connectivity issues.

**Failure observed**: `Timed out while waiting for handshake` (Workflow: GRIMLOCK Heartbeat Monitor, 20+ consecutive failures)

**Pattern to avoid**:
```javascript
// ❌ WRONG - No timeout config, silent failure
SSH Node → Next Node (assumes success)
```

**Correct pattern**:
```javascript
// ✅ CORRECT - Add Error Output + timeout handling
SSH Node (continueOnFail: true) → If Error? → Escalate/Retry
```

**Validation**: SSH nodes should have `continueOnFail` or connect to error handling branch

### [SECURITY] SSH Connection Health Checks

**Rule**: Before running SSH commands in scheduled workflows, verify the target host is reachable. Repeated SSH failures indicate infrastructure issues requiring human intervention.

**Root cause**: EC2 instance may be stopped, security group changed, or SSH key rotated.

**Validation**: Scheduled SSH workflows should escalate after 3+ consecutive failures

